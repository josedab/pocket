#!/usr/bin/env sh
# Pre-commit hook: runs lint-staged + typecheck on changed packages.
# To skip: git commit --no-verify

pnpm lint-staged

# Run typecheck on changed packages (parallel via single turbo invocation)
CHANGED_PACKAGES=$(git diff --cached --name-only --diff-filter=ACMR | grep '^packages/' | cut -d'/' -f2 | sort -u)

if [ -n "$CHANGED_PACKAGES" ]; then
  FILTERS=""
  for pkg in $CHANGED_PACKAGES; do
    if [ -d "packages/$pkg" ]; then
      FILTERS="$FILTERS --filter=@pocket/$pkg"
    fi
  done

  if [ -n "$FILTERS" ]; then
    echo "Typechecking changed packages..."
    npx turbo run typecheck $FILTERS 2>/dev/null || {
      echo "⚠️  Typecheck failed. Use 'git commit --no-verify' to bypass."
      exit 1
    }
  fi
fi
